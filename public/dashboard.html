<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>O‚Äòqituvchi Paneli | Test Tayyor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 to-blue-900 text-white min-h-screen p-6 font-sans">

  <!-- HEADER -->
  <header class="max-w-4xl mx-auto mb-10 text-center">
    <h1 class="text-3xl font-bold mb-2">üë©‚Äçüè´ O‚Äòqituvchi Paneli</h1>
    <p id="teacherName" class="text-lg text-green-300 font-semibold mb-1">Assalomu alaykum!</p>
    <p class="text-gray-300">Test yarating va uni talabalarga ulashish uchun link oling</p>
    <p class="mt-1 text-sm text-gray-400">Google hisobingiz orqali tizimga kirgansiz</p>
  </header>

  <!-- FORM -->
  <main class="max-w-2xl mx-auto bg-white/10 backdrop-blur-md p-6 rounded-xl shadow-xl space-y-6">
    <h2 class="text-xl font-semibold mb-4">üßæ Yangi test yaratish</h2>

    <form id="testForm" enctype="multipart/form-data" class="space-y-4">
      <div>
        <label for="testName" class="block text-sm font-medium">Test nomi</label>
        <input type="text" id="testName" name="testName" class="w-full p-2 rounded text-black" required>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="duration" class="block text-sm font-medium">Test vaqti (daqiqa)</label>
          <input type="number" id="duration" name="duration" min="1" class="w-full p-2 rounded text-black" required>
        </div>
        <div>
          <label for="questionCount" class="block text-sm font-medium">Savollar soni (tasodifiy)</label>
          <input type="number" id="questionCount" name="questionCount" min="1" class="w-full p-2 rounded text-black" required>
        </div>
      </div>

      <!-- Rejim tanlash -->
      <div>
        <span class="block text-sm font-medium mb-1">Rejim</span>
        <label class="mr-4 inline-flex items-center gap-2">
          <input type="radio" name="mode" value="real" checked>
          <span>Real test</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="mode" value="training">
          <span>Training (o‚Äòrganish) rejimi</span>
        </label>
      </div>

      <div>
        <label for="file" class="block text-sm font-medium">üìÅ Test fayli (.txt)</label>
        <input type="file" id="file" name="file" accept=".txt" class="w-full p-2 bg-white rounded text-black" required>
      </div>

      <!-- üì∑ Rasm -->
      <div>
        <label for="image" class="block text-sm font-medium">üñº Test rasmi (jpg/png)</label>
        <input type="file" id="image" name="image" accept="image/*" class="w-full p-2 bg-white rounded text-black">
      </div>

      <div class="flex justify-between items-center">
        <a href="/samples/namuna.txt" download class="text-blue-300 underline text-sm hover:text-blue-200">
          üì• Namuna faylni yuklab olish
        </a>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow">
          Testni yaratish
        </button>
      </div>
    </form>

    <div id="uploadStatus" class="mt-4 text-sm hidden"></div>
  </main>

  <!-- üìã Testlar Ro‚Äòyxati -->
  <section class="max-w-3xl mx-auto mt-12 bg-white/10 backdrop-blur p-6 rounded-xl shadow">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">üìö Yaratilgan testlar</h2>
      <button id="deleteAllBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
        üóëÔ∏è Hammasini o‚Äòchirish
      </button>
    </div>
    <ul id="testList" class="space-y-3"></ul>
  </section>

  <!-- DAK (Exam mode) -->
  <section class="max-w-3xl mx-auto mt-12 bg-white/10 backdrop-blur p-6 rounded-xl shadow">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">DAK</h2>
      <a href="/dak" target="_blank" class="text-blue-300 underline text-sm hover:text-blue-200">/dak</a>
    </div>

    <div class="space-y-6">
      <!-- Exam mode toggle -->
      <div class="flex items-center justify-between gap-4">
        <div>
          <div class="font-semibold">Exam mode</div>
          <div id="examModeStatus" class="text-sm text-gray-300">Yuklanmoqda...</div>
        </div>
        <label class="inline-flex items-center gap-2 select-none">
          <input id="examModeToggle" type="checkbox" class="scale-125">
          <span>ON/OFF</span>
        </label>
      </div>

      <!-- Roster editor -->
      <div class="border-t border-white/10 pt-4">
        <div class="flex items-center justify-between gap-3 mb-2">
          <div class="font-semibold">Roster (JSON)</div>
          <div class="text-xs text-gray-400">data/dak_roster.json</div>
        </div>
        <textarea id="dakRosterTextarea" class="w-full h-64 p-2 rounded text-black font-mono text-xs"
          placeholder="{ ... }"></textarea>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="dakRosterLoadBtn" class="bg-white/10 hover:bg-white/20 border border-white/10 px-3 py-1 rounded text-sm">
            Load
          </button>
          <button id="dakRosterSaveBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
            Save
          </button>
        </div>
        <div id="dakRosterMsg" class="mt-2 text-sm text-gray-300"></div>
      </div>

      <!-- Bank upload -->
      <div class="border-t border-white/10 pt-4">
        <div class="flex items-center justify-between gap-3 mb-2">
          <div class="font-semibold">Savol banklari</div>
          <div class="text-xs text-gray-400">data/dak_banks.json</div>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">subject_name</label>
            <input id="dakSubjectName" type="text" class="w-full p-2 rounded text-black" placeholder="Fan-1">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">file (.txt)</label>
            <input id="dakBankFile" type="file" accept=".txt" class="w-full p-2 bg-white rounded text-black">
          </div>
        </div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="dakUploadBankBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm">
            Upload
          </button>
          <button id="dakRefreshBanksBtn" class="bg-white/10 hover:bg-white/20 border border-white/10 px-3 py-1 rounded text-sm">
            Refresh
          </button>
        </div>
        <div id="dakBanksList" class="mt-3 space-y-2"></div>
        <div id="dakBanksMsg" class="mt-2 text-sm text-gray-300"></div>
      </div>

      <!-- Config -->
      <div class="border-t border-white/10 pt-4">
        <div class="flex items-center justify-between gap-3 mb-2">
          <div class="font-semibold">Config</div>
          <div class="text-xs text-gray-400">data/dak_config.json (yoki app_settings)</div>
        </div>
        <div class="text-sm text-gray-300 flex flex-wrap items-center gap-2">
          <span>Duration:</span>
          <input id="dakCfgDuration" type="number" min="1"
            class="w-20 px-2 py-1 rounded bg-white/10 border border-white/10 text-white" value="80">
          <span>min ‚Ä¢ Total:</span>
          <input id="dakCfgTotal" type="number" min="1"
            class="w-20 px-2 py-1 rounded bg-white/10 border border-white/10 text-white" value="50">
          <span>‚Ä¢ Points/Q:</span>
          <input id="dakCfgPoints" type="number" min="1"
            class="w-20 px-2 py-1 rounded bg-white/10 border border-white/10 text-white" value="2">
        </div>
        <div class="mt-3">
          <label class="block text-sm font-medium mb-1">questions_per_bank</label>
          <input id="dakQuestionsPerBank" type="number" min="1" class="w-full p-2 rounded text-black" value="10">
        </div>
        <div class="mt-3">
          <div class="text-sm font-medium mb-1">Banklar (tanlang)</div>
          <div id="dakConfigBanks" class="space-y-1"></div>
        </div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="dakConfigLoadBtn" class="bg-white/10 hover:bg-white/20 border border-white/10 px-3 py-1 rounded text-sm">
            Load
          </button>
          <button id="dakConfigSaveBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
            Save
          </button>
        </div>
        <div id="dakConfigMsg" class="mt-2 text-sm text-gray-300"></div>
      </div>

      <!-- Export -->
      <div class="border-t border-white/10 pt-4">
        <div class="font-semibold mb-2">Export</div>
        <div class="flex flex-col md:flex-row gap-2">
          <a href="/api/export/DAK_2026-01-22_iqt" target="_blank"
             class="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-2 rounded shadow text-sm text-center">
            DAK Iqtisodiyot (2026-01-22) Export
          </a>
          <a href="/api/export/DAK_2026-01-23_tur" target="_blank"
             class="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-2 rounded shadow text-sm text-center">
            DAK Turizm (2026-01-23) Export
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- SCRIPT -->
  <script>
    const form = document.getElementById('testForm');
    const statusMsg = document.getElementById('uploadStatus');
    const testList = document.getElementById("testList");
    const teacherName = document.getElementById("teacherName");
    const deleteAllBtn = document.getElementById("deleteAllBtn");

    // --- DAK elements ---
    const examModeToggle = document.getElementById("examModeToggle");
    const examModeStatus = document.getElementById("examModeStatus");

    const dakRosterTextarea = document.getElementById("dakRosterTextarea");
    const dakRosterLoadBtn = document.getElementById("dakRosterLoadBtn");
    const dakRosterSaveBtn = document.getElementById("dakRosterSaveBtn");
    const dakRosterMsg = document.getElementById("dakRosterMsg");

    const dakSubjectName = document.getElementById("dakSubjectName");
    const dakBankFile = document.getElementById("dakBankFile");
    const dakUploadBankBtn = document.getElementById("dakUploadBankBtn");
    const dakRefreshBanksBtn = document.getElementById("dakRefreshBanksBtn");
    const dakBanksList = document.getElementById("dakBanksList");
    const dakBanksMsg = document.getElementById("dakBanksMsg");

    const dakCfgDuration = document.getElementById("dakCfgDuration");
    const dakCfgTotal = document.getElementById("dakCfgTotal");
    const dakCfgPoints = document.getElementById("dakCfgPoints");
    const dakQuestionsPerBank = document.getElementById("dakQuestionsPerBank");
    const dakConfigBanks = document.getElementById("dakConfigBanks");
    const dakConfigLoadBtn = document.getElementById("dakConfigLoadBtn");
    const dakConfigSaveBtn = document.getElementById("dakConfigSaveBtn");
    const dakConfigMsg = document.getElementById("dakConfigMsg");

    // üë§ O‚Äòqituvchi ismini chiqarish
    async function loadTeacherInfo() {
      try {
        const res = await fetch("/api/user", { credentials: "include" });
        if (!res.ok) return;
        const user = await res.json();
        teacherName.textContent = `üëã Assalomu alaykum, ${user.name}`;
      } catch {
        teacherName.textContent = "üëã Assalomu alaykum, O‚Äòqituvchi!";
      }
    }

    // üì§ Testni yuklash
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusMsg.className = "mt-4 text-sm";
      statusMsg.classList.add("text-blue-300");
      statusMsg.classList.remove("hidden");
      statusMsg.textContent = "‚è≥ Yuklanmoqda...";

      const formData = new FormData(form);
      try {
        const res = await fetch('/api/upload-test', {
          method: 'POST',
          body: formData,
          credentials: "include"
        });
        if (!res.ok) throw new Error("Upload failed");
        const data = await res.json();
        statusMsg.classList.remove('text-red-400', 'text-blue-300');
        statusMsg.classList.add('text-green-400');
        statusMsg.innerHTML = `
          ‚úÖ Test muvaffaqiyatli yuklandi va yaratildi!<br>
          üîó <strong>Talabalarga ulashish uchun link:</strong>
          <a href="${data.testLink}" target="_blank" class="underline text-blue-300">${location.origin}${data.testLink}</a>
        `;
        form.reset();
        await loadTests(); // ro‚Äòyxatni yangilash
      } catch (err) {
        statusMsg.classList.remove('text-green-400', 'text-blue-300');
        statusMsg.classList.add('text-red-400');
        statusMsg.textContent = "‚ùå Yuklashda xatolik. Qaytadan urinib ko‚Äòring.";
      }
    });

    // üóëÔ∏è Hammasini o‚Äòchirish
    deleteAllBtn.addEventListener("click", async () => {
      if (!confirm("Haqiqatan ham BARCHA testlaringizni o‚Äòchirilsinmi?")) return;
      try {
        const resp = await fetch("/api/tests", { method: "DELETE", credentials: "include" });
        if (!resp.ok) throw new Error();
        await loadTests();
      } catch {
        alert("‚ùå O‚Äòchirishda xatolik!");
      }
    });

    // ‚öôÔ∏è Sozlash modal/prompt orqali ‚Äî PATCH /api/tests/:id/settings
    async function editTestSettings(testId) {
      try {
        // joriy sozlamalarni olib kelamiz (prefill uchun)
        const cur = await fetch(`/api/tests/${testId}/settings`, { credentials: "include", cache: "no-store" });
        if (!cur.ok) {
          const t = await cur.text();
          alert(`‚ùå Sozlamalarni olishda xatolik: ${cur.status} ${t}`);
          return;
        }
        const settings = await cur.json();

        // Vaqt (daq) ‚Äî 0 yoki bo'sh => cheksiz
        const timeInput = prompt(
          `‚è± Vaqt (daqiqa) kiriting.\n0 yoki bo'sh qoldirsangiz ‚Äî cheksiz bo'ladi.\nJoriy qiymat: ${settings.time === null ? "cheksiz" : settings.time + " daq"}`,
          settings.time === null ? "" : String(settings.time)
        );
        if (timeInput === null) return; // bekor qilish

        // Savollar soni
        const qInput = prompt(
          `‚ùì Savollar soni kiriting (1..${settings.totalQuestions}).\nJoriy qiymat: ${settings.questionCount}`,
          String(settings.questionCount || "")
        );
        if (qInput === null) return;

        const body = {};
        if (timeInput !== "") body.time = (timeInput === "0") ? null : parseInt(timeInput, 10);
        else body.time = null; // bo'sh => cheksiz

        if (qInput !== "") body.questionCount = parseInt(qInput, 10);

        const resp = await fetch(`/api/tests/${testId}/settings`, {
          method: "PATCH",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const j = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          alert(`‚ùå Saqlanmadi: ${resp.status} ${j?.error || ""}`);
          return;
        }
        alert("‚úÖ Sozlamalar yangilandi");
        await loadTests();
      } catch (e) {
        console.error(e);
        alert("‚ùå Xatolik. Internetni tekshirib, qayta urinib ko‚Äòring.");
      }
    }

    // üìã Testlar ro‚Äòyxatini yuklash
    async function loadTests() {
      testList.innerHTML = "<li class='text-sm text-gray-300'>‚è≥ Yuklanmoqda...</li>";
      try {
        const res = await fetch("/api/teacher/tests", { credentials: "include", cache: "no-store" });
        const tests = await res.json();

        if (!Array.isArray(tests) || tests.length === 0) {
          testList.innerHTML = "<li>üü° Hozircha testlar mavjud emas</li>";
          return;
        }

        testList.innerHTML = "";
        tests.forEach(test => {
          const li = document.createElement("li");
          li.className = "bg-white/20 p-4 rounded-lg shadow flex justify-between items-center";
          li.innerHTML = `
            <div>
              <div class="font-semibold text-white">üìò ${test.title}</div>
              <div class="text-sm text-blue-300 break-all">
                <a href="${test.link}" target="_blank">${location.origin}${test.link}</a>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button data-id="${test.id}"
                class="edit-one bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm">
                ‚öôÔ∏è Sozlash
              </button>
              <a href="/api/export/${test.id}"
                 class="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-1 rounded shadow text-sm">
                ‚¨á Statistika (.xlsx)
              </a>
              <button data-id="${test.id}"
                class="delete-one bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                üóëÔ∏è O‚Äòchirish
              </button>
            </div>
          `;
          testList.appendChild(li);

          // ‚öôÔ∏è Sozlash
          li.querySelector(".edit-one").addEventListener("click", (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            editTestSettings(id);
          });

          // üóëÔ∏è Bitta testni o‚Äòchirish
          li.querySelector(".delete-one").addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-id");
            if (!confirm("Haqiqatan ham ushbu testni o‚Äòchirmoqchimisiz?")) return;
            try {
              const resp = await fetch(`/api/tests/${id}`, {
                method: "DELETE",
                credentials: "include"
              });
              const txt = await resp.text();
              if (!resp.ok) {
                alert(`‚ùå O‚Äòchirishda xatolik (${resp.status}): ${txt}`);
                return;
              }
              await loadTests();
            } catch (err) {
              alert("‚ùå Tarmoq xatosi. Qayta urinib ko‚Äòring.");
              console.error(err);
            }
          });
        });
      } catch (err) {
        console.error("Xatolik:", err);
        testList.innerHTML = "<li class='text-red-400'>‚ùå Yuklashda xatolik</li>";
      }
    }

    // =========================
    // DAK (Exam mode) helpers
    // =========================
    const dakState = {
      banks: [],
      config: null
    };

    function setMsg(target, msg, isError = false) {
      if (!target) return;
      target.textContent = msg || "";
      target.className = `mt-2 text-sm ${isError ? "text-red-300" : "text-gray-300"}`;
    }

    async function fetchJson(url, opts = {}) {
      const res = await fetch(url, { credentials: "include", ...opts });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch {}
      if (!res.ok) {
        const msg = data?.error || data?.message || text || `${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return data;
    }

    async function loadExamMode() {
      try {
        const data = await fetchJson("/api/public/exam-mode", { cache: "no-store" });
        const enabled = !!data?.enabled;
        if (examModeToggle) examModeToggle.checked = enabled;
        if (examModeStatus) {
          examModeStatus.textContent = enabled
            ? "ON (\"/\" avtomatik /dak ga o'tadi)"
            : "OFF (oddiy holat)";
        }
      } catch (e) {
        if (examModeStatus) examModeStatus.textContent = `Xatolik: ${e.message}`;
      }
    }

    async function setExamMode(enabled) {
      await fetchJson("/api/teacher/exam-mode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ enabled })
      });
    }

    async function loadRoster() {
      try {
        setMsg(dakRosterMsg, "Yuklanmoqda...");
        const roster = await fetchJson("/api/teacher/dak/roster", { cache: "no-store" });
        if (dakRosterTextarea) dakRosterTextarea.value = JSON.stringify(roster, null, 2);
        setMsg(dakRosterMsg, "OK");
      } catch (e) {
        setMsg(dakRosterMsg, e.message, true);
      }
    }

    async function saveRoster() {
      try {
        if (!dakRosterTextarea) return;
        let roster;
        try {
          roster = JSON.parse(dakRosterTextarea.value || "{}");
        } catch {
          setMsg(dakRosterMsg, "JSON format xato", true);
          return;
        }
        setMsg(dakRosterMsg, "Saqlanmoqda...");
        await fetchJson("/api/teacher/dak/roster", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(roster)
        });
        setMsg(dakRosterMsg, "Saved ‚úÖ");
      } catch (e) {
        setMsg(dakRosterMsg, e.message, true);
      }
    }

    function renderBanks() {
      if (!dakBanksList) return;
      dakBanksList.innerHTML = "";

      const banks = Array.isArray(dakState.banks) ? dakState.banks : [];
      if (banks.length === 0) {
        dakBanksList.innerHTML = `<div class="text-sm text-gray-300">Hozircha bank yo‚Äòq</div>`;
        return;
      }

      for (const b of banks) {
        const row = document.createElement("div");
        row.className = "bg-white/10 border border-white/10 rounded p-3 flex items-center justify-between gap-3";
        row.innerHTML = `
          <div class="min-w-0">
            <div class="font-semibold text-sm truncate">${b.subject_name || "Bank"}</div>
            <div class="text-xs text-gray-300">ID: ${b.bank_id} ‚Ä¢ Savollar: ${b.questions_count ?? 0}</div>
          </div>
          <button class="delete-bank bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" data-id="${b.bank_id}">
            Delete
          </button>
        `;
        row.querySelector(".delete-bank").addEventListener("click", async (e) => {
          const id = e.currentTarget.getAttribute("data-id");
          if (!confirm("Bankni o‚Äòchirasizmi?")) return;
          try {
            setMsg(dakBanksMsg, "O‚Äòchirilmoqda...");
            await fetchJson(`/api/teacher/dak/banks/${encodeURIComponent(id)}`, { method: "DELETE" });
            await loadBanks();
            await loadDakConfig(false);
            setMsg(dakBanksMsg, "OK");
          } catch (err) {
            setMsg(dakBanksMsg, err.message, true);
          }
        });
        dakBanksList.appendChild(row);
      }
    }

    function renderConfigBanks() {
      if (!dakConfigBanks) return;
      dakConfigBanks.innerHTML = "";

      const banks = Array.isArray(dakState.banks) ? dakState.banks : [];
      const selected = new Set((dakState.config && Array.isArray(dakState.config.bank_ids)) ? dakState.config.bank_ids : []);

      if (banks.length === 0) {
        dakConfigBanks.innerHTML = `<div class="text-sm text-gray-300">Avval bank yuklang.</div>`;
        return;
      }

      for (const b of banks) {
        const label = document.createElement("label");
        label.className = "flex items-center gap-2 text-sm";
        const checked = selected.has(b.bank_id) ? "checked" : "";
        label.innerHTML = `
          <input type="checkbox" value="${b.bank_id}" ${checked}>
          <span>${b.subject_name || "Bank"} (${b.questions_count ?? 0})</span>
        `;
        dakConfigBanks.appendChild(label);
      }
    }

    async function loadBanks() {
      try {
        setMsg(dakBanksMsg, "Yuklanmoqda...");
        const banks = await fetchJson("/api/teacher/dak/banks", { cache: "no-store" });
        dakState.banks = Array.isArray(banks) ? banks : [];
        renderBanks();
        renderConfigBanks();
        setMsg(dakBanksMsg, `Jami banklar: ${dakState.banks.length}`);
      } catch (e) {
        setMsg(dakBanksMsg, e.message, true);
      }
    }

    async function uploadBank() {
      if (!dakSubjectName || !dakBankFile) return;
      const subject = (dakSubjectName.value || "").trim();
      const file = dakBankFile.files && dakBankFile.files[0];
      if (!subject) return setMsg(dakBanksMsg, "subject_name kiriting", true);
      if (!file) return setMsg(dakBanksMsg, "file tanlang (.txt)", true);

      try {
        setMsg(dakBanksMsg, "Yuklanmoqda...");
        const fd = new FormData();
        fd.append("subject_name", subject);
        fd.append("file", file);
        const res = await fetch("/api/teacher/dak/upload-bank", {
          method: "POST",
          credentials: "include",
          body: fd
        });
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch {}
        if (!res.ok) throw new Error(data?.error || text || `${res.status} ${res.statusText}`);

        dakBankFile.value = "";
        await loadBanks();
        setMsg(dakBanksMsg, `Uploaded ‚úÖ (savollar: ${data?.questions_count ?? "?"})`);
      } catch (e) {
        setMsg(dakBanksMsg, e.message, true);
      }
    }

    async function loadDakConfig(showMsg = true) {
      try {
        if (showMsg) setMsg(dakConfigMsg, "Yuklanmoqda...");
        const cfg = await fetchJson("/api/teacher/dak/config", { cache: "no-store" });
        dakState.config = cfg || null;

        if (dakCfgDuration) dakCfgDuration.value = String(cfg?.duration_minutes ?? 80);
        if (dakCfgTotal) dakCfgTotal.value = String(cfg?.total_questions ?? 50);
        if (dakCfgPoints) dakCfgPoints.value = String(cfg?.points_per_question ?? 2);
        if (dakQuestionsPerBank) dakQuestionsPerBank.value = String(cfg?.questions_per_bank ?? 10);

        renderConfigBanks();
        if (showMsg) setMsg(dakConfigMsg, "OK");
      } catch (e) {
        if (showMsg) setMsg(dakConfigMsg, e.message, true);
      }
    }

    async function saveDakConfig() {
      try {
        const qpb = parseInt(dakQuestionsPerBank?.value || "10", 10);
        const duration = parseInt(dakCfgDuration?.value || "80", 10);
        const total = parseInt(dakCfgTotal?.value || "50", 10);
        const points = parseInt(dakCfgPoints?.value || "2", 10);

        const selected = Array.from(dakConfigBanks?.querySelectorAll("input[type=checkbox]:checked") || [])
          .map((i) => i.value)
          .filter(Boolean);

        if (!Number.isFinite(duration) || duration <= 0) return setMsg(dakConfigMsg, "duration_minutes noto‚Äòg‚Äòri", true);
        if (!Number.isFinite(total) || total <= 0) return setMsg(dakConfigMsg, "total_questions noto‚Äòg‚Äòri", true);
        if (!Number.isFinite(points) || points <= 0) return setMsg(dakConfigMsg, "points_per_question noto‚Äòg‚Äòri", true);
        if (!Number.isFinite(qpb) || qpb <= 0) return setMsg(dakConfigMsg, "questions_per_bank noto‚Äòg‚Äòri", true);
        if (selected.length * qpb !== total) {
          return setMsg(
            dakConfigMsg,
            `Xato: tanlangan banklar (${selected.length}) √ó questions_per_bank (${qpb}) = ${selected.length * qpb} (kerak: ${total})`,
            true
          );
        }

        setMsg(dakConfigMsg, "Saqlanmoqda...");
        const saved = await fetchJson("/api/teacher/dak/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            duration_minutes: duration,
            total_questions: total,
            points_per_question: points,
            questions_per_bank: qpb,
            bank_ids: selected
          })
        });

        dakState.config = saved;
        await loadDakConfig(false);
        setMsg(dakConfigMsg, "Saved ‚úÖ");
      } catch (e) {
        setMsg(dakConfigMsg, e.message, true);
      }
    }

    function initDak() {
      if (!examModeToggle) return;

      examModeToggle.addEventListener("change", async () => {
        examModeToggle.disabled = true;
        try {
          await setExamMode(!!examModeToggle.checked);
          await loadExamMode();
        } catch (e) {
          alert(e.message || "Xatolik");
          await loadExamMode();
        } finally {
          examModeToggle.disabled = false;
        }
      });

      dakRosterLoadBtn?.addEventListener("click", () => loadRoster());
      dakRosterSaveBtn?.addEventListener("click", () => saveRoster());

      dakRefreshBanksBtn?.addEventListener("click", () => loadBanks());
      dakUploadBankBtn?.addEventListener("click", () => uploadBank());

      dakConfigLoadBtn?.addEventListener("click", async () => {
        await loadBanks();
        await loadDakConfig();
      });
      dakConfigSaveBtn?.addEventListener("click", () => saveDakConfig());

      loadExamMode();
      loadRoster();
      loadBanks().then(() => loadDakConfig());
    }

    // Sahifa yuklanganda...
    loadTeacherInfo();
    loadTests();
    initDak();
  </script>
</body>
</html>
